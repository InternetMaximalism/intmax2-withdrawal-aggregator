FROM node:22.14.0-bookworm-slim AS builder

RUN corepack enable && \
    corepack prepare yarn@4.9.1 --activate && \
    yarn set version 4.9.1

RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ && \
    rm -rf /var/lib/apt/lists/*

RUN addgroup --system --gid 1001 builduser && \
    adduser --system --disabled-password --home /home/builduser --uid 1001 --gid 1001 builduser && \
    mkdir -p /usr/src/app && \
    chown builduser:builduser /usr/src/app

WORKDIR /usr/src/app

COPY --chown=builduser:builduser package.json yarn.lock .yarnrc.yml ./
COPY --chown=builduser:builduser packages ./packages/

RUN yarn install --immutable

COPY --chown=builduser:builduser tsconfig.json ./
COPY --chown=builduser:builduser prisma ./prisma

RUN yarn generate
RUN yarn build

RUN mkdir -p /tmp/packages && \
    for pkg in packages/*/; do \
    pkg_name=$(basename $pkg) && \
    mkdir -p /tmp/packages/$pkg_name && \
    if [ -d "$pkg/dist" ]; then cp -r $pkg/dist /tmp/packages/$pkg_name/; fi && \
    if [ -f "$pkg/package.json" ]; then cp $pkg/package.json /tmp/packages/$pkg_name/; fi && \
    find /tmp/packages/$pkg_name -type f -not -path "*/dist/*" -not -name "package.json" -delete && \
    find /tmp/packages/$pkg_name -type d -empty -delete; \
    done

FROM node:22.14.0-bookworm-slim AS production

ENV NODE_ENV=production
ENV NODE_OPTIONS="\
    --max-http-header-size=8192 \
    --max-old-space-size=512 \
    --disable-proto=throw \
    --zero-fill-buffers"

RUN corepack enable && \
    corepack prepare yarn@4.9.1 --activate && \
    yarn set version 4.9.1

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    ca-certificates \
    python3 \
    make \
    g++ && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN addgroup --system --gid 1001 appuser && \
    adduser --system --disabled-password --home /home/appuser --uid 1001 --gid 1001 appuser && \
    mkdir -p /usr/src/app && \
    chown appuser:appuser /usr/src/app

WORKDIR /usr/src/app

COPY --chown=appuser:appuser --from=builder /usr/src/app/package.json /usr/src/app/yarn.lock ./
COPY --chown=appuser:appuser --from=builder /usr/src/app/prisma ./prisma
COPY --chown=appuser:appuser --from=builder /usr/src/app/packages ./packages/
COPY --chown=appuser:appuser --from=builder /usr/src/app/node_modules/.prisma ./node_modules/.prisma

RUN find /usr/src/app -type d -exec chmod 755 {} \; && \
    find /usr/src/app -type f -exec chmod 644 {} \;

USER appuser:appuser

RUN yarn workspaces focus --all --production && \
    rm -rf /home/appuser/tmp/*

EXPOSE 3000

ENTRYPOINT ["yarn"]